// ================= é…ç½®åŒºåŸŸ =================
const DEFAULT_DATA = [
    {
      name: "ç¤ºä¾‹åˆ†ç±»",
      icon: "ğŸš€",
      links: [{ name: "Google", url: "https://google.com", desc: "æœç´¢å¼•æ“" }]
    }
  ];
  
  // ================= Worker åç«¯é€»è¾‘ =================
  export default {
    async fetch(request, env) {
      const url = new URL(request.url);
      const headers = { 
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*' 
      };
  
      // 1. è·å–æ•°æ® (GET)
      if (url.pathname === '/api/data' && request.method === 'GET') {
        try {
          let data = await env.NAV_KV.get('nav_data');
          return new Response(data || JSON.stringify(DEFAULT_DATA), { headers });
        } catch (e) {
          return new Response(JSON.stringify(DEFAULT_DATA), { headers });
        }
      }
  
      // 2. ç™»å½•éªŒè¯ (POST)
      if (url.pathname === '/api/login' && request.method === 'POST') {
        try {
          const { password } = await request.json();
          if (password === env.ADMIN_PASSWORD) {
             return new Response(JSON.stringify({ success: true }), { headers });
          } else {
             return new Response(JSON.stringify({ success: false }), { status: 401, headers });
          }
        } catch (e) {
          return new Response(JSON.stringify({ success: false }), { status: 500, headers });
        }
      }
  
      // 3. ä¿å­˜æ•°æ® (POST)
      if (url.pathname === '/api/data' && request.method === 'POST') {
        try {
          const reqBody = await request.json();
          if (reqBody.password !== env.ADMIN_PASSWORD) {
            return new Response(JSON.stringify({ success: false, message: "å¯†ç é”™è¯¯" }), { 
              status: 401, headers 
            });
          }
          await env.NAV_KV.put('nav_data', JSON.stringify(reqBody.data));
          return new Response(JSON.stringify({ success: true }), { headers });
        } catch (e) {
          return new Response(JSON.stringify({ success: false, message: e.message }), { status: 500, headers });
        }
      }
  
      // 4. è¿”å› HTML
      return new Response(HTML_CONTENT, {
        headers: { 'Content-Type': 'text/html;charset=UTF-8' },
      });
    },
  };
  
  // ================= å‰ç«¯é¡µé¢ä»£ç  =================
  const HTML_CONTENT = `
  <!DOCTYPE html>
  <html lang="zh-CN">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>äº‘ç«¯å¯¼èˆª</title>
      <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>â­</text></svg>">
      <style>
          /* --- å˜é‡å®šä¹‰ --- */
          :root {
              --bg-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
              --text-color: #333;
              --card-bg: rgba(255, 255, 255, 0.9);
              --card-hover-shadow: rgba(0,0,0,0.1);
              --header-text: #fff;
              --header-bg: rgba(255, 255, 255, 0.25);
              --link-bg: #f8f9fa;
              --link-hover-text: #fff;
              --input-bg: #fff;
              --input-border: #eee;
              --modal-bg: #fff;
          }
  
          /* é»‘å¤œæ¨¡å¼ */
          [data-theme="dark"] {
              --bg-gradient: linear-gradient(135deg, #1e2024 0%, #23272e 100%);
              --text-color: #e0e0e0;
              --card-bg: rgba(45, 49, 56, 0.95);
              --card-hover-shadow: rgba(0,0,0,0.4);
              --header-text: #e0e0e0;
              --header-bg: rgba(0, 0, 0, 0.3);
              --link-bg: #363b44;
              --link-hover-text: #fff;
              --input-bg: #2d3138;
              --input-border: #444;
              --modal-bg: #2d3138;
          }
  
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Microsoft YaHei', sans-serif;
              background: var(--bg-gradient);
              min-height: 100vh;
              color: var(--text-color);
              transition: background 0.5s ease;
          }
          .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
  
          header { text-align: center; margin-bottom: 40px; color: var(--header-text); }
          .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
          
          .top-btn-group { display: flex; gap: 10px; }
          .glass-btn {
              background: var(--header-bg); padding: 10px 20px; border-radius: 25px;
              backdrop-filter: blur(10px); color: var(--header-text); 
              cursor: pointer; border: 1px solid rgba(255,255,255,0.2); font-weight: 500;
              display: flex; align-items: center; gap: 5px; transition: 0.3s;
              white-space: nowrap; /* é˜²æ­¢æ—¶é—´æ¢è¡Œ */
          }
          .glass-btn:hover { background: rgba(255,255,255,0.4); transform: translateY(-2px); }
  
          .search-container { text-align: center; margin-bottom: 30px; }
          .search-input { 
              width: 100%; max-width: 500px; padding: 15px 25px; 
              border-radius: 50px; border: none; outline: none; 
              box-shadow: 0 10px 30px rgba(0,0,0,0.1); font-size: 16px; 
              background: var(--input-bg); color: var(--text-color);
          }
  
          .categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; }
          .category { 
              background: var(--card-bg); border-radius: 20px; padding: 25px; 
              transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
          }
          .category:hover { transform: translateY(-5px); box-shadow: 0 15px 30px var(--card-hover-shadow); }
          
          .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid rgba(128,128,128,0.1); padding-bottom: 10px; }
          .category-title { font-size: 1.3em; font-weight: 600; color: var(--text-color); }
  
          .links { display: grid; gap: 10px; }
          .link-item { 
              display: flex; align-items: center; padding: 12px; 
              background: var(--link-bg); border-radius: 10px; 
              text-decoration: none; color: var(--text-color); 
              transition: 0.2s; position: relative; 
          }
          .link-item:hover { 
              background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); 
              color: var(--link-hover-text); 
          }
          .link-content { flex: 1; display: flex; flex-direction: column; }
          .link-name { font-weight: bold; }
          .link-desc { font-size: 0.8em; opacity: 0.7; margin-top: 2px; }
  
          .admin-panel { 
              background: var(--card-bg); padding: 15px 25px; 
              border-radius: 15px; margin-bottom: 20px; 
              display: flex; justify-content: space-between; align-items: center; 
              box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
          }
          .hidden { display: none !important; }
  
          .btn-mini { padding: 4px 8px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; margin-left: 5px; opacity: 0.8; }
          .btn-del { background: #ff7675; color: white; }
          .btn-add { background: #55efc4; color: #008c72; width: 100%; margin-top: 10px; padding: 8px; font-weight: bold; }
          
          .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 999; }
          .modal.show { display: flex; }
          .modal-content { 
              background: var(--modal-bg); padding: 30px; border-radius: 15px; 
              width: 90%; max-width: 350px; text-align: center; 
              box-shadow: 0 20px 50px rgba(0,0,0,0.3); color: var(--text-color);
          }
          .form-input { 
              width: 100%; padding: 12px; margin: 15px 0; 
              border: 1px solid var(--input-border); border-radius: 8px; 
              background: var(--input-bg); color: var(--text-color);
          }
          .btn-primary { width: 100%; padding: 12px; background: #6c5ce7; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
  
          @media (max-width: 768px) {
              .header-top { flex-direction: column; gap: 15px; }
              .top-btn-group { width: 100%; justify-content: center; }
              .glass-btn { width: 100%; justify-content: center; } /* æ‰‹æœºç«¯æ—¶é—´å±…ä¸­ */
          }
      </style>
  </head>
  <body>
      <div class="container">
          <header>
              <div class="header-top">
                  <div class="glass-btn" style="cursor: default;" id="timeDisplay">
                      ğŸ“… åŠ è½½ä¸­...
                  </div>
                  
                  <div class="top-btn-group">
                      <button class="glass-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ</button>
                      <button class="glass-btn" id="loginBtn" onclick="toggleLogin()">ğŸ” ç®¡ç†å‘˜ç™»å½•</button>
                  </div>
              </div>
              
              <h1 style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">â˜ï¸ äº‘ç«¯å¯¼èˆª</h1>
              <p style="opacity:0.9">å®‰å…¨éªŒè¯ Â· è‡ªåŠ¨å¤œé—´æ¨¡å¼</p>
          </header>
  
          <div class="admin-panel hidden" id="adminPanel">
              <div>
                  <strong>ğŸ‘‹ ç®¡ç†å‘˜æ¨¡å¼</strong> 
                  <span id="statusMsg" style="margin-left:10px; font-size:14px; color:green"></span>
              </div>
              <div>
                  <button class="btn-mini" style="background:#0984e3; color:white; padding:8px 15px;" onclick="addCategory()">â• æ–°å»ºåˆ†ç±»</button>
                  <button class="btn-mini" style="background:#636e72; color:white; padding:8px 15px;" onclick="logout()">é€€å‡º</button>
              </div>
          </div>
  
          <div class="search-container">
              <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœç´¢ç½‘ç«™ã€å·¥å…·æˆ–æè¿°...">
          </div>
  
          <div class="categories" id="categoriesContainer">
              <div style="text-align:center; padding:50px; opacity:0.6;">â³ æ•°æ®åŠ è½½ä¸­...</div>
          </div>
          
          <footer style="text-align:center; padding:30px; opacity:0.6; font-size:12px; color: var(--text-color)">
              Â© 2024 Powered by Chenyun
          </footer>
      </div>
  
      <div class="modal" id="loginModal">
          <div class="modal-content">
              <h2 style="margin-bottom:10px;">ç®¡ç†å‘˜è®¤è¯</h2>
              <p style="font-size:12px; opacity:0.7; margin-bottom:15px">è¯·è¾“å…¥ ADMIN_PASSWORD</p>
              <input type="password" id="passwordInput" class="form-input" placeholder="******">
              <button class="btn-primary" id="submitLoginBtn" onclick="handleLogin()">ç¡®è®¤ç™»å½•</button>
              <button style="margin-top:15px; background:none; border:none; color:inherit; opacity:0.6; cursor:pointer" onclick="toggleLogin()">å–æ¶ˆ</button>
          </div>
      </div>
  
      <script>
          let navData = [];
          let isAdmin = false;
          let adminPassword = ""; 
  
          // 1. ä¸»é¢˜ç³»ç»Ÿ
          function initTheme() {
              const savedTheme = localStorage.getItem('theme');
              if (savedTheme) {
                  applyTheme(savedTheme);
                  return;
              }
              const hour = new Date().getHours();
              const isNight = hour >= 18 || hour < 6;
              applyTheme(isNight ? 'dark' : 'light');
          }
  
          function toggleTheme() {
              const current = document.documentElement.getAttribute('data-theme');
              const target = current === 'dark' ? 'light' : 'dark';
              applyTheme(target);
              localStorage.setItem('theme', target);
          }
  
          function applyTheme(theme) {
              if (theme === 'dark') {
                  document.documentElement.setAttribute('data-theme', 'dark');
                  document.getElementById('themeBtn').textContent = 'ğŸŒ™';
              } else {
                  document.documentElement.setAttribute('data-theme', 'light');
                  document.getElementById('themeBtn').textContent = 'ğŸŒ';
              }
          }
  
          // 2. æ•°æ®ä¸äº¤äº’
          async function fetchData() {
              try {
                  const res = await fetch('/api/data');
                  navData = await res.json();
                  render();
              } catch (e) {
                  console.error(e);
                  alert("åŠ è½½å¤±è´¥");
              }
          }
  
          async function saveData() {
              const msg = document.getElementById('statusMsg');
              msg.textContent = "æ­£åœ¨åŒæ­¥...";
              try {
                  const res = await fetch('/api/data', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ password: adminPassword, data: navData })
                  });
                  const result = await res.json();
                  if (result.success) {
                      msg.textContent = "âœ… ä¿å­˜æˆåŠŸ";
                      setTimeout(() => msg.textContent = "", 2000);
                      render();
                  } else {
                      msg.textContent = "âŒ ä¿å­˜å¤±è´¥";
                      if(result.status === 401) alert("èº«ä»½éªŒè¯å¤±æ•ˆ");
                  }
              } catch (e) {
                  msg.textContent = "âŒ ç½‘ç»œé”™è¯¯";
              }
          }
  
          // 3. ç™»å½•é€»è¾‘
          function toggleLogin() {
              const modal = document.getElementById('loginModal');
              modal.classList.toggle('show');
              if (modal.classList.contains('show')) {
                  document.getElementById('passwordInput').focus();
              }
              document.getElementById('passwordInput').value = '';
          }
  
          async function handleLogin() {
              const pwd = document.getElementById('passwordInput').value;
              const btn = document.getElementById('submitLoginBtn');
              if (!pwd) return alert("å¯†ç ä¸èƒ½ä¸ºç©º");
              btn.textContent = "éªŒè¯ä¸­...";
              btn.disabled = true;
  
              try {
                  const res = await fetch('/api/login', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ password: pwd })
                  });
                  const result = await res.json();
                  if (result.success) {
                      adminPassword = pwd;
                      isAdmin = true;
                      document.getElementById('adminPanel').classList.remove('hidden');
                      document.getElementById('loginBtn').classList.add('hidden');
                      toggleLogin();
                      render();
                  } else {
                      alert("âŒ å¯†ç é”™è¯¯");
                  }
              } catch (e) {
                  alert("æ— æ³•è¿æ¥æœåŠ¡å™¨");
              } finally {
                  btn.textContent = "ç¡®è®¤ç™»å½•";
                  btn.disabled = false;
              }
          }
  
          function logout() {
              isAdmin = false;
              adminPassword = "";
              document.getElementById('adminPanel').classList.add('hidden');
              document.getElementById('loginBtn').classList.remove('hidden');
              render();
          }
  
          // 4. æ¸²æŸ“ä¸è¾…åŠ©
          function render() {
              const container = document.getElementById('categoriesContainer');
              container.innerHTML = '';
              navData.forEach((cat, i) => {
                  let linksHtml = '';
                  cat.links.forEach((link, j) => {
                      linksHtml += '<a href="' + link.url + '" target="_blank" class="link-item" data-search="' + link.name + ' ' + link.desc + '">' +
                          '<div class="link-content">' +
                              '<span class="link-name">' + link.name + '</span>' +
                              '<span class="link-desc">' + link.desc + '</span>' +
                          '</div>' +
                          (isAdmin ? '<button class="btn-mini btn-del" onclick="event.preventDefault(); delLink(' + i + ',' + j + ')">Ã—</button>' : '') +
                      '</a>';
                  });
                  if (isAdmin) linksHtml += '<button class="btn-mini btn-add" onclick="addLink(' + i + ')">+ æ·»åŠ é“¾æ¥</button>';
                  container.innerHTML += '<div class="category">' +
                      '<div class="category-header">' +
                          '<div class="category-title">' + cat.icon + ' ' + cat.name + '</div>' +
                          (isAdmin ? '<button class="btn-mini btn-del" onclick="delCat(' + i + ')">åˆ é™¤</button>' : '') +
                      '</div>' +
                      '<div class="links">' + linksHtml + '</div>' +
                  '</div>';
              });
              filterLinks();
          }
  
          function addCategory() {
              const name = prompt("åˆ†ç±»åç§°:"); if(!name) return;
              const icon = prompt("Emoji:", "ğŸ“‚");
              navData.push({name, icon: icon||"ğŸ“‚", links:[]}); saveData();
          }
          function delCat(i) { if(confirm("åˆ é™¤æ­¤åˆ†ç±»?")) { navData.splice(i,1); saveData(); } }
          function addLink(i) {
              const name = prompt("åç§°:"); if(!name) return;
              const url = prompt("ç½‘å€:", "https://");
              const desc = prompt("æè¿°:");
              navData[i].links.push({name, url, desc}); saveData();
          }
          function delLink(i,j) { if(confirm("åˆ é™¤é“¾æ¥?")) { navData[i].links.splice(j,1); saveData(); } }
  
          document.getElementById('searchInput').addEventListener('input', filterLinks);
          function filterLinks() {
              const q = document.getElementById('searchInput').value.toLowerCase();
              document.querySelectorAll('.link-item').forEach(el => {
                  const text = el.getAttribute('data-search').toLowerCase();
                  el.style.display = text.includes(q) ? 'flex' : 'none';
              });
              document.querySelectorAll('.category').forEach(cat => {
                  const hasVisible = cat.querySelectorAll('.link-item[style="display: flex;"]').length > 0;
                  cat.style.display = (q === '' || hasVisible || isAdmin) ? 'block' : 'none';
              });
          }
          
          // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ—¶é—´æ˜¾ç¤ºé€»è¾‘ ---
          function updateTime() {
              const now = new Date();
              const year = now.getFullYear();
              const month = String(now.getMonth() + 1).padStart(2, '0');
              const day = String(now.getDate()).padStart(2, '0');
              const hours = String(now.getHours()).padStart(2, '0');
              const minutes = String(now.getMinutes()).padStart(2, '0');
              const seconds = String(now.getSeconds()).padStart(2, '0');
              
              // åŠ ä¸Šæ˜ŸæœŸå‡ 
              const weeks = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
              const week = weeks[now.getDay()];
  
              document.getElementById('timeDisplay').textContent = 
                  \`\${year}å¹´\${month}æœˆ\${day}æ—¥ \${week} \${hours}:\${minutes}:\${seconds}\`;
          }
          setInterval(updateTime, 1000);
          updateTime();
  
          // ç»‘å®šå›è½¦é”®
          document.getElementById('passwordInput').addEventListener('keypress', function (e) {
              if (e.key === 'Enter') handleLogin();
          });
  
          initTheme();
          fetchData();
      </script>
  </body>
  </html>
  `;
